<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>图观引擎-API代码示例-场景服务-场景服务_风格切换</title>
    <link rel="stylesheet" href="../../css/common.css" />
    <script src="../../js/config.js"></script>
    <script src="//www.tuguan.net/public/tgapp/TGApp.min.js"></script>
    <style>
      ::selection {
        background: transparent !important;
      }

      .app .legends {
        display: none;
      }
      .app > .mask {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="app" id="app">
      <!-- 头部 -->
      <div class="header-wrap">
        <a href="//www.tuguan.net" target="_blank">图观引擎</a><span>-API代码示例-场景服务-场景服务_风格切换</span><br />
        <span class="ctrl">点击按钮，切换不同场景风格</span>
        <img src="../../image/tuguan.png" />
      </div>
      <!-- 第一次预加载添加加载动画 -->
      <div class="mask">
        <section><span class="loader-112">L &nbsp; ading </span></section>
      </div>
      <!-- 场景 -->
      <div id="container"></div>
      <!-- 底部 -->
      <ul class="legends">
        <li class="active" onclick="legendClick(0)">写实化风格</li>
        <li onclick="legendClick(1)">信息化风格(深色)</li>
        <li onclick="legendClick(2)">信息化风格(浅色)</li>
      </ul>
      <!-- 底部 -->
      <div class="footer-box">
        <span>基于图观™数字孪生应用开发引擎构建 https://www.tuguan.net</span>
        <span>版权所有 北京数字冰雹信息技术有限公司</span>
      </div>
    </div>
  </body>
  <script>
    // 实例化图观引擎
    var appInstance = new TGApp.App();

    // 声明并赋值页面交互dom变量
    var lastIndex = 0;
    var legends = [
      {
        serviceName: '默认服务',
        isLoaded: true,
      },
      {
        serviceName: '信息化',
        isLoaded: false,
        token: window.streaming2024Config.chinaBlueToken,
      },
      {
        serviceName: '浅色信息化',
        isLoaded: false,
        token: window.streaming2024Config.chinaWhiteToken,
      },
    ];
    var maskLayer = document.querySelector('.mask');
    var legendPanel = document.querySelector('.legends');

    // 初始化服务
    function init() {
      appInstance.initService(
        {
          name: '默认服务',
          container: document.querySelector('#container'),
          mode: 'streaming',
          token: streaming2024Config.chinaSatToken, //StreamingServer服务器获取token
          url: streaming2024Config.url, //StreamingServer服务器接口地址和端口，需要进行替换为实际地址
        },
        (result) => {
          window.appInstance.uniCall(
            'addEventListener',
            {
              eventName: 'onServiceInit',
              callback: (res) => {
                legendPanel.style.display = 'block';
                onServiceEvent();
              },
            },
            (result) => {
              console.log(result);
            }
          );
        }
      );
    }

    //预加载服务
    function loadService(item) {
      let jsonData = {
        name: item.serviceName, // 服务名称
        url: streaming2024Config.url, // 服务地址
        mode: 'streaming', // 服务模式 scene 端渲染 , streaming 流渲染
        token: item.token, // 服务 Token
      };
      maskLayer.style.display = 'block';
      appInstance.uniCall('loadService', jsonData, (result) => {});
    }

    //切换场景服务
    function switchService(name) {
      window.appInstance.uniCall('switchService', { name: name }, (res) => {
        maskLayer.style.display = 'none';
      });
    }

    function onServiceEvent() {
      //预加载监听
      appInstance.uniCall(
        'addEventListener',
        {
          eventName: 'onServiceLoad',
          callback: function (event) {
            // 监听预加载结束
            legends.forEach((item) => {
              if (event.name == item.serviceName) {
                item.isLoaded = true;
                switchService(item.serviceName);
              }
            });
          },
        },
        (result) => {}
      );
      //切换监听
      appInstance.uniCall(
        'addEventListener',
        {
          eventName: 'onServiceSwitch',
          callback: function (event) {},
        },
        (result) => {}
      );
    }

    //点击切换风格
    function legendClick(index) {
      if (lastIndex == index) {
        return;
      }
      legendPanel.children[lastIndex].classList.remove('active');
      legendPanel.children[index].classList.add('active');
      if (legends[index].isLoaded) {
        // 已经被预加载 直接切换
        switchService(legends[index].serviceName);
      } else {
        // 去预加载场景
        loadService(legends[index]);
      }
      lastIndex = index;
    }

    init();
  </script>
</html>
