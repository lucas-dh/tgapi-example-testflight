<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>图观引擎-API代码示例-建筑对象-获取场景建筑列表</title>
  <link rel="stylesheet" href="../../css/common.css" />
  <script src="../../js/config.js"></script>
  <script src="//www.tuguan.net/public/tgapp/TGApp.min.js"></script>
  <style>
    .app>.avw-loader {
      display: none;
    }

    .app .legends {
      display: none;
    }

    .app .message {
      display: none;
    }
  </style>
</head>

<body>
  <div class="app" id="app">
    <!-- 头部 -->
    <div class="header-wrap">
      <a href="//www.tuguan.net" target="_blank">图观引擎</a><span>-API代码示例-建筑对象-获取场景建筑列表</span><br />
      <span class="ctrl">点击按钮显示场景建筑列表</span>
      <img src="../../image/tuguan.png" />
    </div>
    <!-- 场景 -->
    <div id="container"></div>
    <!-- 按钮菜单 -->
    <ul class="legends" style="top: 14%">
      <li onclick="getBuildingList(event)">获取建筑列表</li>
    </ul>
    <div class="message message_left">
      <code>
          <pre></pre>
        </code>
    </div>
    <div class="message message_right"></div>
    <!-- 底部 -->
    <div class="footer-box">
      <span>基于图观™数字孪生应用开发引擎构建 https://www.tuguan.net</span>
      <span>版权所有 北京数字冰雹信息技术有限公司</span>
    </div>
    <!-- 进度条遮罩 -->
    <div class="avw-loader">
      <section><span class="loader-112">L &nbsp; ading </span></section>
    </div>
  </div>
</body>

<script>
  // 实例化图观引擎
  let appInstance = new TGApp.App();

  // 声明并赋值页面交互dom变量
  let legendPanel = document.querySelector('.legends');
  let messagePanel = document.querySelectorAll('.message');
  let messageLeftPanel = document.querySelector('.message_left code pre');
  let messageRightPanel = document.querySelector('.message_right');
  let avwLoader = document.querySelector('.avw-loader');

  // 初始化加载图观三维场景服务
  function init() {
    appInstance.initService(
      {
        container: document.getElementById('container'),
        mode: 'streaming',
        token: streamingConfigUE5.shequToken, //StreamingServer服务器获取token
        url: streamingConfigUE5.url, //StreamingServer服务器接口地址和端口，需要进行替换为实际地址
      },
      (result) => {
        appInstance.uniCall(
          'addEventListener',
          {
            eventName: 'onServiceInit',
            callback: (res) => {
              //添加TGAPI事件回调，图观场景服务初始化成功后
              // 隐藏遮罩
              avwLoader.style.display = 'none';
              legendPanel.style.display = 'block';
              messagePanel.forEach(item => item.style.display = 'block');
            },
          },
          (result) => {
            console.log(result);
          }
        );
      }
    );
  }

  // 获取建筑列表
  function getBuildingList(event) {
    // 点击高亮菜单按钮
    if (Array.from(event.target.classList).includes('active')) {
      event.target.classList.remove('active');
    } else {
      event.target.classList.add('active');
    }

    appInstance.uniCall('getBuildings', {}, (result) => {
      console.log(result);

      if (result.buildings.length > 0) {
        // 左侧面板数据信息
        messageLeftPanel.innerText = JSON.stringify(result.buildings, null, 2);

        // 右侧面板数据信息
        messageRightPanel.innerHTML = '';
        
        let buildingUl = document.createElement('ul');
        result.buildings.forEach(item => {
          let listItem = document.createElement('li');
          listItem.className = 'building';
          listItem.textContent = item.id;

          let floorUl = document.createElement('ul');

          item.floors.forEach(floor => {
            let ulDom = document.createElement('ul');
            let floorListItem = document.createElement('li');
            floorListItem.className = 'building';
            floorListItem.style.paddingLeft = '40px';
            floorListItem.textContent = floor.num + '层';

            ulDom.appendChild(floorListItem);
            let roomUl = document.createElement('ul');

            floor.rooms.forEach(room => {
              let roomListItem = document.createElement('li');
              roomListItem.className = 'building';
              roomListItem.style.paddingLeft = '70px';
              roomListItem.textContent = room.name;

              roomUl.appendChild(roomListItem);
              ulDom.appendChild(roomUl);
            });

            floorUl.appendChild(ulDom);
          });

          buildingUl.appendChild(listItem);
          buildingUl.appendChild(floorUl);
        });

        messageRightPanel.appendChild(buildingUl);
      }
    });
  }

  init();
</script>

</html>