<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>图观引擎-API代码示例-视野控制-视点跟随</title>
  <link rel="stylesheet" href="../../css/common.css" />
  <link rel="stylesheet" href="../../css/elementui.css" />
  <script src="../../js/config.js"></script>

  <script src="//www.tuguan.net/public/tgapp/TGApp.min.js"></script>
  <!-- <script src="../../lib/axios.js"></script>
  <script src="../../lib/vue.js"></script>
  <script src="../../lib/elementui.js"></script>
  <script src="./main.js"></script> -->
  <style>
    .legends div {
      width: 200px;
      padding: 5px 10px;
      color: #fff;
      margin: 4px 0;
      cursor: pointer;
      font-size: 20px;
      text-align: center;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgb(0, 42, 52);
    }

    .legends div .el-checkbox {
      width: 40px;
    }

    .legends div .el-checkbox .el-checkbox__input {
      width: 16px;
      height: 16px;
      display: inline-block;
      margin-left: 10px;
      cursor: pointer;
    }
    .app>.avw-loader {
      display: none;
    }
  </style>
</head>

<body>
  <div class="app" id="app">
    <!-- 头部 -->
    <div class="header-wrap">
      <a href="//www.tuguan.net" target="_blank">图观引擎</a><span>-API代码示例-视野控制-视点跟随</span><br />
      <span class="ctrl">点击按钮设置镜头跟随模型效果，勾选复选框开启/关闭环绕效果</span>
      <img src="../../image/tuguan.png" />
    </div>
    <!-- 场景 -->
    <div id="container"></div>
    <!-- 底部 -->
    <ul class="legends">
      <!-- <li style="width: 200px" v-for="(item,index) in legendList" :key="item.id"
        @click.stop="changeModelArticulation(item)" :class="[item.active?'active':'']">
        {{item.action}}
      </li> -->
      <div><span>环绕</span>
        <!-- <el-checkbox v-model="isSelfActive" ></el-checkbox> -->
        <input type="checkbox" class="checkbox" onchange="changeRelative()"/>
      </div>
    </ul>
    <!-- 底部 -->
    <div class="footer-box">
      <span>基于图观™数字孪生应用开发引擎构建 https://www.tuguan.net</span>
      <span>版权所有 北京数字冰雹信息技术有限公司</span>
    </div>
    <!-- 进度条遮罩 -->
    <div class="avw-loader">
      <section><span class="loader-112">L &nbsp; ading </span></section>
    </div>
  </div>
</body>

</html>
<script>
  var isZZ = true; //是否显示遮罩
  var isOne = true; // 是否第一次执行持续路径移动模型
  var isSelfActive = false; // 是否开启环绕
  var legendList = [
    {
      id: 1,
      action: '镜头跟随模型-自身',
      value: 'self',
      active: false,
    },
    {
      id: 2,
      action: '镜头跟随模型-世界',
      value: 'world',
      active: false,
    },
  ];
  var pathData = [
    { coord: [116.3500334325, 40.0827615907], coordZ: 0.2571975037 },
    { coord: [116.3500098172, 40.0834542161], coordZ: 0.2571975037 },
    { coord: [116.3489790818, 40.0834668793], coordZ: 0.2571975037 },
    { coord: [116.3490214442, 40.0841187598], coordZ: 0.2571975037 },
    { coord: [116.3501087593, 40.0841149262], coordZ: 0.2571975037 },
    { coord: [116.3501196232, 40.0848165199], coordZ: 0.2571975037 },
    { coord: [116.3490582181, 40.0848213169], coordZ: 0.2571975037 },
  ];

  //改变前端样式方法
  function initStyle() {
    if (isZZ) {
      document.getElementsByClassName('avw-loader')[0].display = 'flex';
    } else {
      document.getElementsByClassName('avw-loader')[0].display = 'none';
    }
    if(isSelfActive){
      document.getElementsByClassName('checkbox')[0].checked = true;
    }else{
      document.getElementsByClassName('checkbox')[0].checked = false;
    }

    var list = document.getElementsByClassName('legends');
    var removeList = list[0].querySelectorAll('li');
    removeList.forEach(value => {
      value.remove();
    });

    legendList.forEach(value => {
      // 创建新的li元素
      var newLi = document.createElement('li');
      newLi.textContent = value.action;
      newLi.style.width = '200px';
      if(value.active){
        newLi.class = 'active'
      }else{
        newLi.class = ''
      }
      // newLi.click = 'changeModelArticulation(value)';
      // 给新添加的元素添加点击事件
      newLi.addEventListener('click', (event) => changeModelArticulation(value));
      list[0].insertBefore(newLi,list[0].firstChild);
    });

  }

  var avwLoader = document.querySelector('.avw-loader');

  // 初始化加载图观三维场景服务
  function init() {
    // 初始化图观App
    window.appInstance = new TGApp.App();
    window.appInstance.initService(
      {
        container: document.getElementById('container'),
        mode: 'streaming',
        token: streaming2024Config.fieldControlToken, //StreamingServer服务器获取token
        url: streaming2024Config.url, //StreamingServer服务器接口地址和端口，需要进行替换为实际地址
      },
      (result) => {
        //添加TGAPI事件回调，图观场景服务初始化成功后
        window.appInstance.uniCall(
          'addEventListener',
          {
            eventName: 'onServiceInit',
            callback: (res) => {
              // 隐藏遮罩
              avwLoader.style.display = 'flex';
              appInstance.uniCall(
                'switchState',
                {
                  name: '默认状态',
                  sceneName: '默认场景',
                },
                (result) => {
                  avwLoader.style.display = 'none';
                  addPath();
                  addModel();
                  // 注册跟随镜头改变事件
                  window.appInstance.uniCall('addEventListener', {
                    eventName: 'onFollowingCameraChanged',
                    callback: (result) => {
                      console.log('onFollowingCameraChanged', result);
                      handleMouseUp(result);
                    },
                  });
                  initStyle();
                }
              );
            },
          },
          (result) => {
            console.log(result);
          }
        );
      }
    );
  };

  // 添加路径
  function addPath() {
    let jsonData = {
      id: 'path',
      name: '路径',
      coordType: 0,
      coordTypeZ: 0,
      type: 'Segment06',
      texture: 'cableFlow.png',
      textureSpeed: 0,
      color: '#00ff00',
      colorPass: '#0000ff',
      width: 10,
      tag: 'custominfo', // 用户自定标签，用户保存用户的扩展数据
      autoScale: false,
      visible: true,
      lineDataId: '', // 对应本服务器上线数据对象，如果找到lineDataId，则下方的points不起作用。注意：此属性端渲染未生效
      points: [],
    };
    jsonData.points = pathData;
    appInstance.uniCall('addPath', jsonData, (result) => { });
  };

  //添加模型
  function addModel(){
    let jsonData = { state: 'free' }; //restricted：受限；free：不受限制
    appInstance.uniCall('setCameraRestrictionState', jsonData, result => {
      console.log(result);
    });
    let rowData = {
      id: "car01-1",
      coordType: 0,
      coordTypeZ: 0,
      coord: [116.35001351310761, 40.08278768181128],
      coordZ: 1.5,
      rotation: [0, 0, 0],
      alpha: 1,
      scale: 2,
      titleText: "",
      titleColor: "#ffffff",
      titleBackgroundColor: "#333333",
      titleFontSize: 10,
      titileAutoScale: false,
      visible: true,
      isReferenceType: false,
      modelType: "car01"
    }

    appInstance.uniCall('addModel', rowData, (result) => {
      console.log(result);
    });
  };

  // 显示场景信息
  function showSceneInfo() {
    appInstance.uniCall(
      'showSceneInfo',
      {
        isOpen: true,
      },
      (result) => {
        console.log(result);
      }
    );
  };

  // 环绕
  function changeRelative() {
    isSelfActive = document.getElementsByClassName('checkbox')[0].checked;
    if (isSelfActive) {
      appInstance.uniCall(
        'rotateCamera',
        {
          enabled: true,
          duration: 50,
          direction: 'counterclockwise',
          interruptable: true,
        },
        (result) => {
          console.log(result);
        }
      );
    } else {
      stopRotate();
    }
  };

  // 停止环绕
  function stopRotate() {
    let jsonData = {
      enabled: false, // 是否启用相机围绕目标飞行
      duration: 60, // 飞行一周所需要的秒数，数值越大飞行越慢
      interruptable: true, // 是否可以被打断，默认为true
      direction: 'clockwise', // 飞行方向，clockwise 为顺时针，counterclockwise 为逆时针
    };

    appInstance.uniCall('rotateCamera', jsonData, (result) => {
      console.log(result);
    });
  };

  // 按钮点击事件
  function changeModelArticulation(el) {
    legendList.forEach((item) => {
      if (item.id == el.id) {
        item.active = true;
      } else {
        item.active = false;
      }
    });
    initStyle();
    followingCamera(el);
  };

  // 镜头跟随模型
  function followingCamera(el) {
    let heading = 0,
      relative = 'self';
    if (el.value == 'self') {
      // 自身
      // 模型应该车头面向场景正面 但当前为反面 所以模型旋转180
      heading = 180;
      relative = 'self';
    } else {
      // 世界
      heading = 0;
      relative = 'world';
    }
    // 镜头跟随模型
    appInstance.uniCall(
      'followingCamera',
      {
        modelId: 'car01-1',
        distance: 40,
        distanceMin: 5,
        pitch: 6,
        heading: heading,
        relative: relative,
      },
      (result) => {
        console.log(result);
        if (isOne) {
          // 持续路径移动模型
          appInstance.uniCall(
            'pathingModel',
            {
              id: 'car01-1',
              pathId: 'path',
              loopMode: 'round', //循环模式：none，不循环；round，往返；repeat，从头循环
              reverse: false, //是否反向移动
              direction: 'path',
              offset: [0, 0, 1.3],
              speed: 20, //移动速度 (单位:米/秒)
            },
            (result) => {
              isOne = false;
              console.log(result);
            }
          );
        }
      }
    );
  };

  // 设置按钮状态
  function handleMouseUp(r) {
    // self
    legendList[0].active = r.relative == 'self' ? true : false;
    // world
    legendList[1].active = r.relative == 'world' ? true : false;
    // 环绕
    isSelfActive = r.enableRotate ? true : false;
    initStyle();
  }

  init();
  initStyle();

</script>