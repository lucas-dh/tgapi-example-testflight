<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>图观引擎-API代码示例-数据图层-地标图_瓦片球体_全球卫星</title>
    <link rel="stylesheet" href="../../css/common.css" />
    <script src="../../js/config.js"></script>
    <script src="//www.tuguan.net/public/tgapp/TGApp.min.js"></script>
    <style>
      ::selection {
        background: transparent !important;
      }
      .allLengs {
        top: 13%;
        display: none;
      }
      .legends {
        transform: translateY(-250px);
        display: none;
      }
      .legends input {
        pointer-events: none;
      }
    </style>
  </head>

  <body>
    <div class="app" id="app">
      <!-- 头部 -->
      <div class="header-wrap">
        <a href="https://www.tuguan.net" target="_blank">图观引擎</a><span>-API代码示例-数据图层-地标图_瓦片球体_全球卫星</span><br />
        <span>点击按钮，地标图切换展示全球卫星分布情况</span>
        <img src="../../image/tuguan.png" />
      </div>
      <div class="allLengs">当前对象总数<span id="spCount">947</span>条</div>
      <!-- 场景 -->
      <div id="container"></div>
      <!-- 图例 -->
      <ul class="legends">
        <li onclick="legendClick(this,'技术试验',69)">
          <span>技术试验</span>
          <input type="checkbox" checked="checked" />
        </li>
        <li onclick="legendClick(this,'通讯',558)">
          <span>通讯</span>
          <input type="checkbox" checked="checked" />
        </li>
        <li onclick="legendClick(this,'科研',10)">
          <span>科研</span>
          <input type="checkbox" checked="checked" />
        </li>
        <li onclick="legendClick(this,'地球观测',97)">
          <span>地球观测</span>
          <input type="checkbox" checked="checked" />
        </li>
        <li onclick="legendClick(this,'监测',4)">
          <span>监测</span>
          <input type="checkbox" checked="checked" />
        </li>
        <li onclick="legendClick(this,'空间探索',27)">
          <span>空间探索</span>
          <input type="checkbox" checked="checked" />
        </li>
        <li onclick="legendClick(this,'广播',2)">
          <span>广播</span>
          <input type="checkbox" checked="checked" />
        </li>
        <li onclick="legendClick(this,'遥感',53)">
          <span>遥感</span>
          <input type="checkbox" checked="checked" />
        </li>
        <li onclick="legendClick(this,'天文',11)">
          <span>天文</span>
          <input type="checkbox" checked="checked" />
        </li>
        <li onclick="legendClick(this,'导航',95)">
          <span>导航</span>
          <input type="checkbox" checked="checked" />
        </li>
        <li onclick="legendClick(this,'气象',14)">
          <span>气象</span>
          <input type="checkbox" checked="checked" />
        </li>
        <li onclick="legendClick(this,'侦察',6)">
          <span>侦察</span>
          <input type="checkbox" checked="checked" />
        </li>
        <li onclick="legendClick(this,'电子监控',1)">
          <span>电子监控</span>
          <input type="checkbox" checked="checked" />
        </li>
      </ul>
      <!-- 底部 -->
      <div class="footer-box">
        <span>基于图观™数字孪生应用开发引擎构建 https://www.tuguan.net</span>
        <span>版权所有 北京数字冰雹信息技术有限公司</span>
      </div>
    </div>
  </body>
  <script>
    // 实例化图观引擎
    var appInstance = new TGApp.App();

    // 声明并赋值页面交互dom变量
    var count = 947; //总对象数
    var legendPanel = document.querySelector('.legends');
    var countPanel = document.querySelector('.allLengs');
    var spCount = document.querySelector('#spCount');

    // 初始化服务
    function init() {
      appInstance.initService(
        {
          container: document.querySelector('#container'),
          mode: 'streaming',
          token: streaming2024Config.globalgisToken, //StreamingServer服务器获取token
          url: streaming2024Config.url, //StreamingServer服务器接口地址和端口，需要进行替换为实际地址
        },
        (result) => {
          window.appInstance.uniCall(
            'addEventListener',
            {
              eventName: 'onServiceInit',
              callback: (res) => {
                legendPanel.style.display = 'block';
                countPanel.style.display = 'block';

                // 添加各类型图层
                addLandmarkLayers();
              },
            },
            (result) => {
              console.log(result);
            }
          );
        }
      );
    }

    // 添加地标图
    function addLandmarkLayer(purpose, records) {
      let purposeData = records.filter((record) => record.Purpose === purpose);
      let data = purposeData.map((item) => {
        return {
          id: item.ID,
          type: 'satellite',
          label: item.Name,
          coord: [item.Longitude, item.Latitude],
          coordZ: item.Altitude,
        };
      });
      let jsonData = {
        id: purpose,
        name: '城市图层',
        coordType: 0,
        coordTypeZ: 0,
        autoScale: false,
        visible: true,
        legends: [
          {
            name: 'satellite',
            color: '#73FFFF',
            iconName: 'satellite',
            labelScale: 0.5,
            iconScale: 0.3,
          },
        ],
        data: data,
      };

      appInstance.uniCall('addLandmarkLayer', jsonData, (result) => {
        console.log(result);
      });
    }

    //控制显示隐藏
    function legendClick(li, Ids, number) {
      li.children[1].checked = !li.children[1].checked;
      if (li.children[1].checked) {
        count += number;
      } else {
        count -= number;
      }
      spCount.textContent = count;
      let jsonData = {
        id: Ids,
        overlayType: 'landmarkLayer',
        visible: li.children[1].checked,
      };
      appInstance.uniCall('setOverlayVisibility', jsonData, (result) => {
        console.log(result);
      });
    }

    // 添加各类地标图
    function addLandmarkLayers() {
      getJsonData('./json/全球卫星.json').then((data) => {
        let purposes = Array.from(new Set(data.RECORDS.map((record) => record.Purpose)));
        purposes.forEach((purpose) => {
          addLandmarkLayer(purpose, data.RECORDS);
        });
      });
    }

    // 获取数据
    function getJsonData(url) {
      return new Promise((resolve) => {
        fetch(url, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' },
        })
          .then((response) => {
            if (response.ok) {
              return response.json();
            }
          })
          .then((res) => {
            resolve(res);
          });
      });
    }

    init();
  </script>
</html>
