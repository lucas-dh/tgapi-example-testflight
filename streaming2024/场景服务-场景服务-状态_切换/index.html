<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>图观引擎-API代码示例-场景服务-场景服务_状态 切换</title>
    <link rel="stylesheet" href="../../css/common.css" />
    <script src="../../js/config.js"></script>
    <script src="//www.tuguan.net/public/tgapp/TGApp.min.js"></script>
    <style>
      ::selection {
        background: transparent !important;
      }
    </style>
  </head>
  <body>
    <div class="app" id="app">
      <div class="header-wrap">
        <a href="//www.tuguan.net" target="_blank">图观引擎</a><span>-API代码示例-场景服务-场景服务_状态 切换</span><br />
        <!-- 点击路径漫游按钮，实现以第一人称视角进行按照既定路径移动镜头跟随 -->
        <span class="ctrl">点击按钮，切换不同场景状态</span>
        <img src="../../image/tuguan.png" />
      </div>
      <div id="container"></div>
      <ul class="legends"></ul>
      <div class="footer-box">
        <span>基于图观™数字孪生应用开发引擎构建 https://www.tuguan.net</span>
        <span>版权所有 北京数字冰雹信息技术有限公司</span>
      </div>
    </div>
  </body>

  <script>
    // 实例化图观引擎
    var appInstance = new TGApp.App();

    // 声明并赋值页面交互dom变量
    var lastIndex = 0;
    var states = [];
    var sceneName = '智慧社区多状态';
    var legendPanel = document.querySelector('.legends');

    // 初始化服务
    function init() {
      appInstance.initService(
        {
          container: document.querySelector('#container'),
          mode: 'streaming',
          token: streamingConfigUE5.shequToken, //StreamingServer服务器获取token
          url: streamingConfigUE5.url, //StreamingServer服务器接口地址和端口，需要进行替换为实际地址
        },
        (result) => {
          window.appInstance.uniCall(
            'addEventListener',
            {
              eventName: 'onServiceInit',
              callback: (res) => {
                //获取状态信息
                appInstance.uniCall('getStates', {}, (result) => {
                  console.log(result);

                  states = result.states.filter((state) => state.sceneName === sceneName);
                  states.forEach((item, index) => {
                    let li = document.createElement('li');
                    li.classList.add('li');
                    li.innerText = item.name;
                    li.onclick = function () {
                      legendClick(index);
                    };

                    //获取到数组的第一项改变为默认选中状态
                    if (index == 0) {
                      li.classList.add('active');
                    }
                    legendPanel.appendChild(li);
                  });
                });
              },
            },
            (result) => {
              console.log(result);
            }
          );
        }
      );
    }

    //切换状态
    function switchStatus(name) {
      appInstance.uniCall(
        'switchState',
        {
          name: name,
          sceneName: sceneName,
        },
        (result) => {
          console.log(result);
        }
      );
    }

    //点击切换状态
    function legendClick(index) {
      if (lastIndex == index) {
        return;
      }
      legendPanel.children[lastIndex].classList.remove('active');
      legendPanel.children[index].classList.add('active');
      switchStatus(states[index].name);
      lastIndex = index;
    }

    init();
  </script>
</html>
